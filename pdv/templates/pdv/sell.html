{% extends 'pdv/base.html' %}

{% block title %}Ventas{% endblock %}

{% block content %}
<div x-data='{articles:{}, payed:0, change:0, total:0, enough: false, count:0}' x-init='
    $watch("articles", val => {total=computeTotal(val); change=payed-total; count=Object.keys(articles).length});
    $watch("payed", val => {change=payed-total; enough = change >= 0})'>
  <script type='text/javascript'>
    function addOrIncrement(articleList, article) {
      let id = article.id;
      if (id in articleList) {
        let max = articleList[id].max;
        let quantity = articleList[id].quantity;
        articleList[id].quantity = quantity >= max ? max : quantity + 1;
        return;
      }
      articleList[id] = {
        max: parseInt(article.max),
        price: parseFloat(article.price),
        name: article.name,
        id: article.id,
        quantity: 1
      };
    }

    function incrementQuantity(articleList, id) {
      if (articleList[id].quantity + 1 >= articleList[id].max) {
        return;
      }
      articleList[id].quantity++;
    }

    function decrementQuantity(articleList, id) {
      if (articleList[id].quantity - 1 <= 0) {
        return;
      }
      articleList[id].quantity--;
    }

    function computeTotal(articleList) {
      return Object.values(articleList).reduce((acc, val) => acc + val.price * val.quantity, 0);
    }

  </script>
  <article class='secondary-container'>
    <h5>Venta</h5>
    <br>
    <div class="container margin">
      <search>
        <form class="grid middle-align" hx-get="{% url 'pdv:article_search' %}" hx-trigger="submit" hx-validate
          hx-target="#searchResults" hx-indicator="spinner" x-data="{searchtext:''}">
          {% csrf_token %}
          <div class="suffix prefix no-margin s5 field fill primary large border">
            <i class="front">barcode_reader</i>
            <input type="search" id="barname-search" maxlength="128" name="barname" autocomplete="off"
              x-model="searchtext" autofocus tabindex="0" placeholder="Escribir nombre o codigo de barras" minlength="3"
              hx-trigger="input changed delay:300ms" hx-get="{% url 'pdv:article_search' %}" hx-validate
              hx-indicator="#spinner" hx-on::after-request="this.value=''" required @focus="$el.select()" />
            <progress id="spinner" class="htmx-indicator circle"></progress>
          </div>
        </form>
      </search>
      <div id="searchResults">
      </div>
    </div>

    <form id="sale_form" method='post' action='{% url "pdv:makesale" %}'>
      <input x-ref="print_input" type="hidden" name="print" value="0" />
      <div id='articles-section' class="padding margin">
        <template x-for='article in articles'>
          <!-- POR CADA ARTICULO EN LA LISTA DE ARTICULOS -->
          <div class='grid middle-align slideRight'>
            <span class='s5'>
              <h5 x-text='article.name'></h5>
            </span>
            <span class='s4'>
              <h5 x-text='`$ ${article.price}`'></h5>
            </span>
            <span class='s2'>
              <nav class='no-space'>
                <button type='button' class='border large left-round' @click='incrementQuantity(articles, article.id)'>
                  <i>add</i>
                </button>
                <div style='max-width: 6em;' class='field min border no-round border'>
                  <input type='number' :name='article.id' min='1' step='1' :max='article.max'
                    x-model='article.quantity' />
                </div>
                <button type='button' class='border large right-round' @click='decrementQuantity(articles, article.id)'>
                  <i>remove</i>
                </button>
              </nav>
            </span>
            <span class='s1 padding'>
              <button class='circle tertiary' @click='delete articles[article.id]'><i>close</i></button>
            </span>
          </div>
          <!-- FIN -->
        </template>
        <dialog class="modal grid padding" x-ref="sale_dialog">
          <h4 class="s5">Pagado</h4>
          <div class='s7 small prefix fill field border' style='margin-bottom: 0; max-width: 18em;'>
            <i>attach_money</i>
            <input form="sale_form" name='payed' type='number' placeholder='Cantidad pagada' x-model='payed'
              :min='total' step='0.01' required />
          </div>
          <h4 class="s5">Total</h4>
          <h4 class="s7" x-text='`$ ${total}`'></h4>
          <h4 class="s5">Cambio</h4>
          <h4 class='s7' x-text='enough? `$ ${change}`: " Pago insuficiente"'></h4>
          <nav class="s12 no-space">
            <button type="submit" @click.capture='$refs.print_input.value = 1; $refs.sale_dialog.open = true'
              class="vertical border left-round primary extra"><i>print</i> Cobrar e imprimir ticket </button>
            <button type="submit" @click.capture='$refs.print_input.value = 0; $refs.sale_dialog.open = true'
              class="vertical border no-round primary extra"><i>payments</i> Cobrar </button>
            <button type="button" @click='$refs.sale_dialog.open = false'
              class="vertical border right-round tertiary extra"><i>close</i> Cancelar </button>
          </nav>
        </dialog>
      </div>

      <div class='large-space'></div> <!-- BRUH -->
      {% csrf_token %}
      <nav class='no-space'>
        <button type="button" @click.capture='$refs.sale_dialog.open = true'
          class='vertical border left-round primary extra' disabled x-init="$watch('count', (c)=>$el.disabled=c<=0)">
          <i>paid</i>
          <span>Cobrar</span>
        </button>
        <button type="button" @click='$refs.confirm_dialog.open = true'
          class='vertical border right-round tertiary extra'><i>delete</i> Cancelar venta </button>
      </nav>
    </form>
    <dialog class='modal' x-ref='confirm_dialog'>
      <h5>Advertencia</h5>
      <div class='row'>Â¿Cancelar la venta?</div>
      <nav>
        <button @click='$refs.confirm_dialog.open=false; articles={}'><i>check</i></button>
        <button @click='$refs.confirm_dialog.open=false'><i>close</i></button>
      </nav>
    </dialog>
  </article>
  <div>
    {% endblock %}