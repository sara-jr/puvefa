{% extends 'pdv/base.html' %}

{% block title %}Ventas{% endblock %}

{% block content %}
<div x-data='{articles:{}}'>
  <script>
    function addOrIncrement(articleList, article){
      if(article.id in articleList){
        articleList[article.id].quantity++;
        return;
      }
      articleList[article.id] = {...article, quantity: 1};
    }

    function computeTotal(articleList){
      return Object.values(articleList).map((a)=>a.price*a.quantity).reduce((a,b)=>a+b, 0);
    }

    window.onkeydown = function(){
      const element = document.getElementById('barname-search');
      element.focus();
    };
    
    window.onkeyup = function(){
      let el = document.getElementById('search-results');
      el.children[0].focus();
    }
    
  </script>
  <article class='secondary-container'>
    <h5>Venta</h5>
    <br>
    <div class='container'>
      <div class='suffix field prefix fill primary large border'>
        <i class='front'>barcode_reader</i>
        <input type='search'
          id='barname-search'
          hx-get="/pdv/activesearch"
          hx-trigger="keyup changed delay:300ms"
          hx-target="#search-results" 
          hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'            
          pattern='.{2,}'
          name='barname'
          onblur='this.value = ""; this.classList.toggle("shake")'
          onfocus='this.classList.toggle("shake")'
          autofocus
          placeholder='Escribir nombre o codigo de barras'/>
        <i class="front">close</i>
      </div>
      <menu x-ref='searchres' id='search-results'>
      </menu>
    </div>
    <table class='border medium-space'>
      <thead>
        <tr> 
          <th><h6>Nombre</h6></th> 
          <th><h6>Cantidad</h6></th> 
          <th><h6>Precio</h6></th> 
          <th><h6>Opciones</h6></th> 
        </tr>
      </thead>
      <tbody>
        <template x-for='article in Object.values(articles)'>
          <tr class='slideRight'>
            <td><p class='large-text' x-text='article.name'></p></td>
            <td x-text='article.quantity'></td>
            <td>$<span x-text='article.price'></span></td>
            <td>
              <nav class='no-space'>
                <button 
                x-on:click='article.quantity++' 
                class='extra circle left-round'>
                  <i>add</i>
                </button>
                <button 
                x-on:click='article.quantity--' 
                class='extra circle square'>
                  <i>remove</i>
                </button>
                <button 
                x-on:click='delete articles[article.id]'
                class='extra circle tertiary right-round'>
                  <i>delete</i>
                </button>
              </nav>
            </td>
          </tr>
        </template>
      </tbody>
      <tfoot>
        <tr>
          <th><h5>Total a pagar</h5></th>
          <td>
              $<span x-text='computeTotal(articles)'></span>
          </td>
        </tr>
      </tfoot>
    </table>

    <div class='large-space'></div> <!-- BRUH -->
    <form method='post' action='{% url "pdv:makesale" %}'>
      {% csrf_token %}
      <nav class='no-space'>
        <template x-for='article in articles'>
          <input type='hidden' x-bind:name='article.id' x-bind:value='article.quantity' />
        </template>
        <button type='submit' class='vertical border left-round primary extra'><i>print</i> Cobrar e imprimir ticket </button>
        <button type='submit' @click='$refs.articles_input.value = articles' class='vertical border no-round primary extra'><i>payments</i> Cobrar </button>
        <button type='button' @click='$refs.confirm_dialog.open = true' class='vertical border right-round tertiary extra'><i>close</i> Cancelar venta </button>
      </nav>
    </form>
    <dialog class='modal' x-ref='confirm_dialog'>
      <h5>Advertencia</h5>
      <div class='row'>Â¿Cancelar la venta?</div>
      <nav>
        <button @click='$refs.confirm_dialog.open=false; articles={}'><i>check</i></button>
        <button @click='$refs.confirm_dialog.open=false'><i>close</i></button>
      </nav>
    </dialog>
  </article>
<div>
{% endblock %}
